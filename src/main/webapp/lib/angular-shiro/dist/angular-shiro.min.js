/**
 * angular-shiro
 * @version v0.1.0 - 2014-09-07
 * @link https://github.com/gnavarro77/angular-shiro
 * @author Gilles Navarro ()
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
!function(){"use strict";function a(){this.options={loginUrl:"/login",urls:{"/":"anon","/index":"anon","/login":"anon","/signin":"anon","/logout":"logout","/signout":"logout"},login:{uri:"/api/authenticate",path:"/login"},logout:{uri:"/api/logout",path:"logout",redirectUrl:"/"}},this.$get=[function(){return this.options}]}function b(){this.$get=["$q","$http","$timeout","angularShiroConfig",function(a,b,c,d){return{authenticate:function(c){var e=null;if(!c||!c.getPrincipal()||!c.getCredentials())throw"[Autheticate] Can not authenticate. Invalid token provided!";if(!(d&&d.login&&d.login.uri))throw"[Autheticate] Can not authenticate since no 'config.login.uri' is provided. Please check your configuration.";var f=a.defer();return b.post(d.login.uri,{token:{principal:c.getPrincipal(),credentials:c.getCredentials()}}).success(function(a){f.resolve(a)}).error(function(a){f.reject(a)}),e=f.promise}}}]}function c(){this.username=null,this.password=null,this.getPrincipal=function(){return this.username},this.getCredentials=function(){return this.password}}function d(a,b){this.principal=a,this.credentials=b,this.getPrincipal=function(){return this.principal},this.getCredentials=function(){return this.credentials}}function e(a,b){this.WILDCARD_TOKEN="*",this.PART_DIVIDER_TOKEN=":",this.SUBPART_DIVIDER_TOKEN=",",this.caseSensitive=b?b:!1,this.parts,this.implies=function(a){var b=angular.isDefined(a)&&this.getParts().length>0;if(b){a=angular.isString(a)?new e(a):a;for(var c=a.getParts(),d=c.length,f=this.getParts(),g=0,h=f.length;h>g;g++){var i=f[g];if(d>g){var j=c[g];if(!this.containsWildCardToken(i)&&!this.containsAll(i,j)){b=!1;break}}else if(!this.containsWildCardToken(i)){b=!1;break}}}return b},this.containsAll=function(a,b){for(var c=!0,d=0;d<b.length;d++)if(-1===a.indexOf(b[d])){c=!1;break}return c},this.containsWildCardToken=function(a){return a.indexOf(this.WILDCARD_TOKEN)>-1},this.resolveParts=function(a,b){var c=[];if(angular.isDefined(a)&&angular.isString(a)){a=a.trim?a.trim():a;var d=a.split(this.PART_DIVIDER_TOKEN);angular.forEach(d,function(a){c.push(this.resolveSubParts(a,b))},this)}return c},this.resolveSubParts=function(a,b){var c=[],d=a.split(this.SUBPART_DIVIDER_TOKEN),e=0;return angular.forEach(d,function(a){a=a.trim?a.trim():a,a=b===!1?angular.lowercase(a):a,c[e++]=a}),c},this.getParts=function(){return this.parts},this.parts=this.resolveParts(a,b)}function f(a,b){this.roles=angular.isArray(a)?a:[],this.permissions=angular.isArray(b)?b:[],this.getRoles=function(){return this.roles},this.getPermissions=function(){return this.permissions},this.getStringPermissions=function(){for(var a=[],b=0,c=this.permissions.length;c>b;b++){var d=this.permissions[b];angular.isString(d)&&a.push(d)}return a},this.getObjectPermissions=function(){for(var a=[],b=0,c=this.permissions.length;c>b;b++){var d=this.permissions[b];d instanceof e&&a.push(d)}return a}}function g(){this.permissions,this.authorizationInfo,this.setAuthorizationInfo=function(a){if(!(a&&null!==a&&a instanceof f))throw{illegalArgumentException:"invalid value for authorizationInfo"};this.authorizationInfo=a,this.permissions=this.getPermissions(a)},this.clear=function(){this.authorizationInfo=this.permissions=null},this.isPermitted=function(a){var b;return angular.isArray(a)?(b=[],angular.forEach(a,function(a){b.push(this.isObjectPermissionPermitted(this.resolvePermission(a)))},this)):b=this.isObjectPermissionPermitted(this.resolvePermission(a)),b},this.isPermittedAll=function(a){return-1===this.isPermitted(a).indexOf(!1)},this.hasRole=function(a){var b=!1;return a&&(b=this.authorizationInfo.getRoles().indexOf(a)>-1),b},this.hasRoles=function(a){var b=[];return a&&angular.isArray(a)&&angular.forEach(a,function(a){b.push(this.hasRole(a))},this),b},this.hasAllRoles=function(a){return-1===this.hasRoles(a).indexOf(!1)},this.getPermissions=function(a){for(var b=a.getObjectPermissions(),c=a.getStringPermissions(),d=0,f=c.length;f>d;d++)b.push(new e(c[d]));return b},this.isObjectPermissionPermitted=function(a){for(var b=!1,c=0,d=this.permissions.length;d>c&&!b;c++)b=this.permissions[c].implies(a);return b},this.resolvePermission=function(a){return angular.isString(a)?new e(a):a}}function h(){this.DEFAULT_PATH_SEPARATOR="/",this.pathSeparator=this.DEFAULT_PATH_SEPARATOR,this.setPathSeparator=function(a){this.pathSeparator=null!==a?a:this.DEFAULT_PATH_SEPARATOR},this.match=function(a,b){return this.doMatch(a,b,!0)},this.doMatch=function(a,b,c){if(b.startsWith(this.pathSeparator)!==a.startsWith(this.pathSeparator))return!1;for(var d=a.split(this.pathSeparator),e=b.split(this.pathSeparator),f=0,g=d.length-1,h=0,i=e.length-1;g>=f&&i>=h;){var j=d[f];if("**"===j)break;if(!this.matchStrings(j,e[h]))return!1;f++,h++}if(h>i){if(f>g)return a.endsWith(this.pathSeparator)?b.endsWith(this.pathSeparator):!b.endsWith(this.pathSeparator);if(!c)return!0;if(f===g&&"*"===d[f]&&b.endsWith(this.pathSeparator))return!0;for(var k=f;g>=k;k++)if("**"!==d[k])return!1;return!0}if(f>g)return!1;if(!c&&"**"===d[f])return!0;for(;g>=f&&i>=h;){var j=d[g];if("**"===j)break;if(!this.matchStrings(j,e[i]))return!1;g--,i--}if(h>i){for(var k=f;g>=k;k++)if("**"!==d[k])return!1;return!0}for(;f!==g&&i>=h;){for(var l=-1,k=f+1;g>=k;k++)if("**"===d[k]){l=k;break}if(l!==f+1){for(var m=l-f-1,n=i-h+1,o=-1,k=0;n-m>=k;k++){for(var p=0;m>p;p++){var q=d[f+p+1],r=e[h+k+p];!this.matchStrings(q,r)}o=h+k;break}if(-1===o)return!1;f=l,h=o+m}else f++}for(var k=f;g>=k;k++)if("**"!==d[k])return!1;return!0},this.matchStrings=function(a,b){var c,d=a.split(""),e=b.split(""),f=0,g=d.length-1,h=0,i=e.length-1,j=this.containsStar(a);if(!j){if(g!==i)return!1;for(var k=0;g>=k;k++)if(c=d[k],"?"!==c&&c!==e[k])return!1;return!0}if(0===g)return!0;for(;"*"!==(c=d[f])&&i>=h;){if("?"!==c&&c!==e[h])return!1;f++,h++}if(h>i){for(var k=f;g>=k;k++)if("*"!==d[k])return!1;return!0}for(;"*"!==(c=d[g])&&i>=h;){if("?"!==c&&c!==e[i])return!1;g--,i--}if(h>i){for(var k=f;g>=k;k++)if("*"!==d[k])return!1;return!0}for(;f!==g&&i>=h;){for(var l=-1,k=f+1;g>=k;k++)if("*"===d[k]){l=k;break}if(l!==f+1){var m=l-f-1,n=i-h+1,o=-1;a:for(var k=0;n-m>=k;k++){for(var p=0;m>p;p++)if(c=d[f+p+1],"?"!==c&&c!==e[h+k+p])continue a;o=h+k;break}if(-1===o)return!1;f=l,h=o+m}else f++}for(var k=f;g>=k;k++)if("*"!==d[k])return!1;return!0},this.containsStar=function(a){var b=!1;if(a&&null!==a)for(var c=0;c<a.length;c++)if("*"===a.charAt(c)){b=!0;break}return b}}function i(){this.parse=function(a){return this.checkValidity(a),{authc:this.parseAuthc(a.info.authc),authz:this.parseAuthz(a.info.authz)}},this.parseAuthc=function(a){return new d(a.principal,a.credentials)},this.parseAuthz=function(a){return new f(a.roles,a.permissions)},this.checkValidity=function(a){if(!(angular.isDefined(a)&&angular.isDefined(a.info)&&this.isAuthcValid(a.info)&&this.isAuthzValid(a.info))){var b="Response does not match expected structure.";throw{name:"ParseException",message:b}}},this.isAuthcValid=function(a){var b=angular.isDefined(a.authc);if(b){var c=a.authc;b=angular.isDefined(c.principal)&&angular.isDefined(c.credentials)}return b},this.isAuthzValid=function(a){var b=angular.isDefined(a.authz);if(b){var c=a.authz;b=angular.isDefined(c.roles)&&angular.isDefined(c.permissions)}return b}}function j(a,b,c){this.authenticated=!1,this.authorizer=b,this.authenticationInfo,this.login=function(b){var d=a.authenticate(b),e=this;return d.then(function(a){var d=c.parse(a);e.authenticationInfo=d.authc,e.authorizer.setAuthorizationInfo(d.authz),e.authenticated=!0,b.username=null,b.password=null},function(){e.clear()}),d},this.logout=function(){this.clear()},this.clear=function(){this.authenticated=!1,this.authenticationInfo=null,this.authorizer.clear()},this.getSession=function(){},this.getPrincipal=function(){var a="";return angular.isDefined(this.authenticationInfo)&&angular.isObject(this.authenticationInfo)&&(a=this.authenticationInfo.getPrincipal()),a},this.isAuthenticated=function(){return this.authenticated},this.hasRole=function(a){return this.isAuthenticated()&&angular.isDefined(this.authorizer)&&this.authorizer.hasRole(a)},this.hasRoles=function(a){var b=[];return angular.forEach(a,function(a){b.push(this.hasRole(a))},this),b},this.hasAllRoles=function(a){return this.isAuthenticated()&&this.authorizer.hasAllRoles(a)},this.isPermitted=function(a){return this.isAuthenticated()&&this.authorizer.isPermitted(a)},this.isPermittedAll=function(a){return this.isAuthenticated()&&this.authorizer.isPermittedAll(a)}}function k(a){var b=a[0],c=a[a.length-1];if(b===c)return angular.element(b);var d=b,e=[d];do{if(d=d.nextSibling,!d)break;e.push(d)}while(d!==c);return angular.element(e)}var l=["angularShiroConfig","$injector",function(a,b){var c=new h,d=a.urls;return{resolve:function(a){var b=this.resolveStringFilters(a);return this.resolveFilters(b)},resolveFilters:function(a){var b=[];if(a)for(var c=a.split(","),d=0;d<c.length;d++){var e=this.resolveFilter(c[d]);null!==e&&b.push(e)}return b},resolveFilter:function(a){var c=null,d=this.resolveFilterName(a),e=this.resolveFilterArgs(a);return c=b.get(d),function(){return c.execute(e)}},resolveFilterName:function(a){var b=a;return this.isParametrizedFilter(a)&&(b=a.substr(0,a.indexOf("["))),I(b)},resolveFilterArgs:function(a){var b=null;if(this.isParametrizedFilter(a)){var c=a.indexOf("["),d=a.indexOf("]"),e=a.substr(c+1,d-c-1),f=e.split(",");b=[],angular.forEach(f,function(a){b.push(I(a))})}return b},resolveStringFilters:function(a){var b=null;for(var e in d)if(c.match(e,a)){b=d[e];break}return b},isParametrizedFilter:function(a){return a.indexOf("perms")>-1||a.indexOf("roles")>-1}}}],m=function(a,b,c){c&&c.login&&c.login.path&&a(function(){b.path(c.login.path)})},n=["subject","$log",function(a,b){return{execute:function(){return b.debug("anon::execute"),!0}}}],o=["$rootScope","subject","angularShiroConfig","$location","$timeout","$log",function(a,b,c,d,e,f){return{execute:function(){return f.debug("authc::execute"),this.isAccessAllowed()||this.onAccessDenied()},isAccessAllowed:function(){var a=b.isAuthenticated();return f.debug("authc::isAccessAllowed => "+a),a},onAccessDenied:function(){return m(e,d,c),!1}}}],p=["subject","angularShiroConfig","$location","$timeout","$log",function(a,b,c,d,e){return{execute:function(){return e.debug("logoutFilter::execute"),a.logout(),b.logout&&b.logout.redirectUrl&&(c.path(b.logout.redirectUrl),e.debug("logout::redirecting to => "+b.logout.redirectUrl)),!0}}}],q=["subject","angularShiroConfig","$location","$timeout","$log",function(a,b,c,d,e){return{execute:function(a){return e.debug("perms::execute"),this.isAccessAllowed(a)||this.onAccessDenied()},isAccessAllowed:function(b){var c=a.isPermittedAll(b);return e.debug("perms::isAccessAllowed => "+c),c},onAccessDenied:function(){return m(d,c,b),!1}}}],r=["subject","angularShiroConfig","$location","$timeout","$log",function(a,b,c,d,e){return{execute:function(a){return e.debug("roles::execute"),this.isAccessAllowed(a)||this.onAccessDenied()},isAccessAllowed:function(b){var c=a.hasAllRoles(b);return e.debug("roles::isAccessAllowed => "+c),c},onAccessDenied:function(){return m(d,c,b),!1}}}];angular.module("angularShiro.templates",["templates/usernamePasswordForm.html"]),angular.module("templates/usernamePasswordForm.html",[]).run(["$templateCache",function(a){a.put("templates/usernamePasswordForm.html",'<div>\n	<div style="padding-top: 10px; padding-bottom: 10px;"\n		data-ng-show="error">\n		<span class="label label-danger label-important"\n			data-ng-bind="labels[\'connection.denied.message\']"> </span>\n	</div>\n	<form name="loginForm" data-role="form" data-ng-submit="submit()"\n		novalidate>\n		<div class="form-group">\n			<input name="username" type="text" class="form-control"\n				placeholder="{{labels[\'field.username.placeholder\']}}"\n				data-ng-model="token.username" required />\n		</div>\n		<div class="form-group">\n			<input name="password" type="password" class="form-control"\n				placeholder="{{labels[\'field.password.placeholder\']}}"\n				data-ng-model="token.password" required />\n		</div>\n		<div class="form-group">\n			<button type="submit" class="btn btn-primary btn-block"\n				data-ng-disabled="loginForm.$pristine || loginForm.$invalid">\n				<span data-ng-bind="labels[\'button.submit.label\']"></span>\n			</button>\n		</div>\n	</form>\n</div>')}]);var s=["subject","$animate",function(a,b){return{transclude:"element",priority:600,terminal:!0,restrict:"A",$$tlb:!0,link:function(c,d,e,f,g){var h,i,j;c.$watch(function(){return a.authenticated},function(){a.isAuthenticated()?i||(i=c.$new(),g(i,function(a){h={clone:a},b.enter(a,d.parent(),d)})):(j&&(j.remove(),j=null),i&&(i.$destroy(),i=null),h&&(j=k(h.clone),b.leave(j,function(){j=null}),h=null))})}}}],t=["subject","$animate",function(a,b){return{transclude:"element",priority:600,terminal:!0,restrict:"A",$$tlb:!0,link:function(c,d,e,f,g){var h,i,j;c.$watch(function(){return a.authenticated},function(){var f=c.$eval(e.hasAnyPermission)||e.hasAnyPermission;f=angular.isArray(f)?f:[f];var l=a.isPermitted(f);angular.isArray(l)&&l.indexOf(!0)>-1?i||(i=c.$new(),g(i,function(a){h={clone:a},b.enter(a,d.parent(),d)})):(j&&(j.remove(),j=null),i&&(i.$destroy(),i=null),h&&(j=k(h.clone),b.leave(j,function(){j=null}),h=null))})}}}],u=["subject","$animate",function(a,b){return{transclude:"element",priority:600,terminal:!0,restrict:"A",$$tlb:!0,link:function(c,d,e,f,g){var h,i,j;c.$watch(function(){return a.authenticated},function(){var f=c.$eval(e.hasAnyRole)||e.hasAnyRole;f=angular.isArray(f)?f:[f],a.hasRoles(f).indexOf(!0)>-1?i||(i=c.$new(),g(i,function(a){h={clone:a},b.enter(a,d.parent(),d)})):(j&&(j.remove(),j=null),i&&(i.$destroy(),i=null),h&&(j=k(h.clone),b.leave(j,function(){j=null}),h=null))})}}}],v=["subject","$animate",function(a,b){return{transclude:"element",priority:600,terminal:!0,restrict:"A",$$tlb:!0,link:function(c,d,e,f,g){var h,i,j;c.$watch(function(){return a.authenticated},function(f){f=c.$eval(e.hasPermission)||e.hasPermission,a.isPermitted(f)?i||(i=c.$new(),g(i,function(a){h={clone:a},b.enter(a,d.parent(),d)})):(j&&(j.remove(),j=null),i&&(i.$destroy(),i=null),h&&(j=k(h.clone),b.leave(j,function(){j=null}),h=null))})}}}],w=["subject","$animate",function(a,b){return{transclude:"element",priority:600,terminal:!0,restrict:"A",$$tlb:!0,link:function(c,d,e,f,g){var h,i,j;c.$watch(function(){return a.authenticated},function(){var f=e.hasRole;a.hasRole(f)?i||(i=c.$new(),g(i,function(a){h={clone:a},b.enter(a,d.parent(),d)})):(j&&(j.remove(),j=null),i&&(i.$destroy(),i=null),h&&(j=k(h.clone),b.leave(j,function(){j=null}),h=null))})}}}],x=["subject","$animate",function(a,b){return{transclude:"element",priority:600,terminal:!0,restrict:"A",$$tlb:!0,link:function(c,d,e,f,g){var h,i,j;c.$watch(function(){return a.authenticated},function(){var f=c.$eval(e.lacksPermission)||e.lacksPermission;a.isPermitted(f)?(j&&(j.remove(),j=null),i&&(i.$destroy(),i=null),h&&(j=k(h.clone),b.leave(j,function(){j=null}),h=null)):i||(i=c.$new(),g(i,function(a){h={clone:a},b.enter(a,d.parent(),d)}))})}}}],y=["subject","$animate",function(a,b){return{transclude:"element",priority:600,terminal:!0,restrict:"A",$$tlb:!0,link:function(c,d,e,f,g){var h,i,j;c.$watch(function(){return a.authenticated},function(){var f=e.lacksRole;a.hasRole(f)?(j&&(j.remove(),j=null),i&&(i.$destroy(),i=null),h&&(j=k(h.clone),b.leave(j,function(){j=null}),h=null)):i||(i=c.$new(),g(i,function(a){h={clone:a},b.enter(a,d.parent(),d)}))})}}}],z=["subject","$animate",function(a,b){return{transclude:"element",priority:600,terminal:!0,restrict:"A",$$tlb:!0,link:function(c,d,e,f,g){var h,i,j;c.$watch(function(){return a.authenticated},function(){a.isAuthenticated()?(j&&(j.remove(),j=null),i&&(i.$destroy(),i=null),h&&(j=k(h.clone),b.leave(j,function(){j=null}),h=null)):i||(i=c.$new(),g(i,function(a){h={clone:a},b.enter(a,d.parent(),d)}))})}}}],A=["subject",function(a){return{restrict:"E",replace:!0,scope:{},template:'<span class="principal" ng-bind="getPrincipal()"></span>',link:function(b,c,d){b.getPrincipal=function(){var b=a.getPrincipal();return angular.isObject(b)&&(b=d.property&&angular.isDefined(b[d.property])?b[d.property]:angular.toJson(b)),b}}}}],B=["subject","usernamePasswordToken",function(a,b){var c={"field.username.placeholder":"Username","field.password.placeholder":"Password","button.submit.label":"Connection","connection.denied.message":"Username and password do not match"};return{restrict:"E",replace:!0,templateUrl:"templates/usernamePasswordForm.html",scope:{onSuccess:"&",onError:"&"},link:function(d,e,f){d.error=!1,d.token=b,d.labels=angular.isDefined(f.labels)?angular.extend(c,angular.fromJson(f.labels)):c,d.$watch("token.getPrincipal()",function(){d.error=!1}),d.$watch("token.getCredentials()",function(){d.error=!1}),d.submit=function(){a.login(b).then(function(a){angular.isDefined(d.onSuccess)&&d.onSuccess({data:a}),b.username=b.password=null},function(a){d.error=!0,angular.isDefined(d.onError)&&d.onError({data:a})})}}}}],C=angular.module("angularShiro.services",[]);C.provider("authenticator",b),C.provider("angularShiroConfig",a),C.factory("subject",["authenticator","authorizer","authenticationResponseParser",function(a,b,c){return new j(a,b,c)}]),C.factory("usernamePasswordToken",function(){return new c}),C.factory("authorizer",function(){return new g}),C.factory("authenticationResponseParser",function(){return new i});var D={anon:n,authc:o,logout:p,perms:q,roles:r};for(var E in D)C.factory(E,D[E]);C.factory("filtersResolver",l);var F={hasRole:w,notAuthenticated:z,authenticated:s,lacksRole:y,hasAnyRole:u,hasPermission:v,lacksPermission:x,hasAnyPermission:t,principal:A,usernamePasswordForm:B},G=angular.module("angularShiro.directives",[]);for(var H in F)G.directive(H,F[H]);angular.module("angularShiro",["angularShiro.services","angularShiro.directives","angularShiro.templates"]).run(["$rootScope","$location","subject","angularShiroConfig","filtersResolver","$log",function(a,b,c,d,e){a.$on("$locationChangeStart",function(a){for(var c=e.resolve(b.path()),d=0;d<c.length;d++){var f=c[d];if(!f()){a.preventDefault();break}}})}]);var I=function(){return String.prototype.trim?function(a){return angular.isString(a)?a.trim():a}:function(a){return angular.isString(a)?a.replace(/^\s\s*/,"").replace(/\s\s*$/,""):a}}()}(window,document);